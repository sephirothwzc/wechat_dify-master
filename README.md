# ä¼ä¸šå¾®ä¿¡ Dify AI åŠ©æ‰‹ (WechatLaibao)

ä¸€ä¸ªåŸºäºä¼ä¸šå¾®ä¿¡æœºå™¨äººå’ŒDifyå¹³å°çš„æ™ºèƒ½AIåŠ©æ‰‹ï¼Œæ”¯æŒæµå¼å¯¹è¯ã€ç”¨æˆ·è®¤è¯å’Œåˆ†å¸ƒå¼éƒ¨ç½²ã€‚

## ğŸŒŸ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¼ä¸šå¾®ä¿¡æœºå™¨äººä¸Dify AIå¹³å°çš„æ·±åº¦é›†æˆï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·è®¤è¯æµç¨‹å’ŒçœŸæ­£çš„æµå¼å¯¹è¯ä½“éªŒã€‚ç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼æ¶æ„è®¾è®¡ï¼Œæ”¯æŒé«˜å¹¶å‘å’Œè´Ÿè½½å‡è¡¡éƒ¨ç½²ã€‚
å› ä¸ºæœ¬é¡¹ç›®æ˜¯åŠ å…¥äº†ä½œè€…ä¸€äº›ä¸‰æ–¹ç³»ç»Ÿçš„éªŒè¯ï¼Œå’Œdifyçš„apiéªŒè¯æ”¹é€ ï¼Œæ‰€æœ‰ç›´æ¥ä½¿ç”¨ä¼šæœ‰é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥å€Ÿé‰´æˆ‘çš„ä»£ç ï¼Œåˆ é™¤ä¸€äº›ä¸éœ€è¦çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥äº†ã€‚

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **Webæ¡†æ¶**: Flask 2.3.3
- **ç¼“å­˜å­˜å‚¨**: Redis 5.0.1  
- **æ•°æ®åº“**: MySQL (ç”¨æˆ·è®¤è¯)
- **åŠ å¯†ç»„ä»¶**: PyCryptodome 3.19.0
- **HTTPå®¢æˆ·ç«¯**: Requests 2.31.0
- **å¼‚æ­¥å¤„ç†**: Python Threading

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    A[ä¼ä¸šå¾®ä¿¡ç”¨æˆ·] --> B[ä¼ä¸šå¾®ä¿¡æœåŠ¡å™¨]
    B --> C[WechatLaibaoåº”ç”¨]
    C --> D[ç”¨æˆ·è®¤è¯æœåŠ¡]
    C --> E[æµå¼ç®¡ç†å™¨]
    C --> F[WeChatæœåŠ¡]
    
    D --> G[Redisç¼“å­˜]
    D --> H[MySQLæ•°æ®åº“]
    D --> I[å¤–éƒ¨è®¤è¯API]
    
    E --> G
    E --> J[Dify AIå¹³å°]
    
    F --> K[æ¶ˆæ¯åŠ å¯†/è§£å¯†]
    
    subgraph "åˆ†å¸ƒå¼æ”¯æŒ"
        C1[åº”ç”¨èŠ‚ç‚¹1]
        C2[åº”ç”¨èŠ‚ç‚¹2]
        C3[åº”ç”¨èŠ‚ç‚¹N]
    end
    
    subgraph "å­˜å‚¨å±‚"
        G[Redisé›†ç¾¤]
        H[MySQLä¸»ä»]
    end
    
    C1 --> G
    C2 --> G
    C3 --> G
```

## ğŸ”„ æŠ€æœ¯æµç¨‹

### 1. ç”¨æˆ·è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä¼ä¸šå¾®ä¿¡ç”¨æˆ·
    participant W as ä¼ä¸šå¾®ä¿¡æœåŠ¡å™¨
    participant A as WechatLaibaoåº”ç”¨
    participant R as Redis
    participant M as MySQL
    participant E as å¤–éƒ¨è®¤è¯API
    
    U->>W: å‘é€æ¶ˆæ¯
    W->>A: æ¨é€åŠ å¯†æ¶ˆæ¯
    A->>A: è§£å¯†æ¶ˆæ¯
    A->>R: æŸ¥è¯¢token (authorization.wechatid.{userid})
    
    alt Tokenå­˜åœ¨
        A->>R: éªŒè¯token (authorization.token.{token})
        alt Tokenæœ‰æ•ˆ
            A->>A: è®¤è¯æˆåŠŸï¼Œç»§ç»­å¤„ç†
        else Tokenæ— æ•ˆ
            A->>M: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
            A->>E: è°ƒç”¨è®¤è¯APIè·å–æ–°token
            A->>R: å­˜å‚¨æ–°token
        end
    else Tokenä¸å­˜åœ¨
        A->>M: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        A->>E: è°ƒç”¨è®¤è¯APIè·å–æ–°token
        A->>R: å­˜å‚¨æ–°token
    end
```

### 2. æµå¼å¯¹è¯å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä¼ä¸šå¾®ä¿¡ç”¨æˆ·
    participant W as ä¼ä¸šå¾®ä¿¡æœåŠ¡å™¨
    participant A as WechatLaibaoåº”ç”¨
    participant S as StreamManager
    participant R as Redis
    participant D as Difyå¹³å°
    
    Note over U,D: æ–‡æœ¬æ¶ˆæ¯å¤„ç†
    U->>W: å‘é€æ–‡æœ¬æ¶ˆæ¯
    W->>A: æ¨é€æ¶ˆæ¯
    A->>A: ç”¨æˆ·è®¤è¯
    A->>S: åˆ›å»ºæµå¼ä»»åŠ¡
    S->>R: å­˜å‚¨åˆå§‹çŠ¶æ€
    S->>S: å¯åŠ¨ç‹¬ç«‹çº¿ç¨‹
    A->>W: è¿”å›"æ€è€ƒä¸­..."æ¶ˆæ¯
    W->>U: æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
    
    Note over S,D: ç‹¬ç«‹çº¿ç¨‹å¤„ç†Dify
    S->>D: å‘é€æµå¼è¯·æ±‚
    loop Difyæµå¼å“åº”
        D->>S: è¿”å›å†…å®¹å—
        S->>R: å­˜å‚¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    end
    D->>S: æµå¼å®Œæˆ
    S->>R: æ ‡è®°å®ŒæˆçŠ¶æ€
    
    Note over U,R: ä¼å¾®æµå¼è¯·æ±‚
    loop ä¼å¾®streamè¯·æ±‚
        U->>W: è‡ªåŠ¨å‘é€streamè¯·æ±‚
        W->>A: æ¨é€streamæ¶ˆæ¯
        A->>S: è·å–ä¸‹ä¸€æ¡æœªè¯»æ¶ˆæ¯
        S->>R: è¯»å–å¹¶æ ‡è®°å·²è¯»
        A->>W: è¿”å›å†…å®¹å—
        W->>U: æ˜¾ç¤ºç´¯ç§¯å†…å®¹
    end
```

### 3. æ¶ˆæ¯åŠ å¯†/è§£å¯†æµç¨‹

```mermaid
flowchart LR
    A[ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯] --> B[Base64è§£ç ]
    B --> C[AESè§£å¯†]
    C --> D[XMLè§£æ]
    D --> E[JSONæå–]
    E --> F[æ¶ˆæ¯å¤„ç†]
    
    F --> G[å“åº”ç”Ÿæˆ]
    G --> H[JSONåºåˆ—åŒ–]
    H --> I[AESåŠ å¯†]
    I --> J[Base64ç¼–ç ]
    J --> K[è¿”å›ä¼ä¸šå¾®ä¿¡]
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
WechatLaibao/
â”œâ”€â”€ app.py                          # Flaskä¸»åº”ç”¨
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ settings.py                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auth_service.py             # ç”¨æˆ·è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ dify_service.py             # Difyå¹³å°æ¥å£
â”‚   â”œâ”€â”€ stream_manager.py           # æµå¼å“åº”ç®¡ç†å™¨
â”‚   â””â”€â”€ wechat_service.py           # ä¼ä¸šå¾®ä¿¡æœåŠ¡
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ stream_utils.py             # æµå¼æ¶ˆæ¯å·¥å…·
â”œâ”€â”€ demo/
â”‚   â”œâ”€â”€ WXBizJsonMsgCrypt.py        # ä¼ä¸šå¾®ä¿¡åŠ å¯†ç»„ä»¶
â”‚   â””â”€â”€ ierror.py                   # é”™è¯¯ç å®šä¹‰
â”œâ”€â”€ requirements.txt                # é¡¹ç›®ä¾èµ–
â””â”€â”€ README.md                       # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. åˆ†å¸ƒå¼æ¶æ„æ”¯æŒ
- **æ— çŠ¶æ€è®¾è®¡**: æ‰€æœ‰çŠ¶æ€å­˜å‚¨åœ¨Redisä¸­
- **è´Ÿè½½å‡è¡¡**: æ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²å’Œè´Ÿè½½å‡è¡¡
- **æ°´å¹³æ‰©å±•**: å¯æ ¹æ®è´Ÿè½½åŠ¨æ€å¢å‡èŠ‚ç‚¹
- **æ•…éšœæ¢å¤**: å•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡

### 2. æ™ºèƒ½ç”¨æˆ·è®¤è¯
- **å¤šçº§ç¼“å­˜**: Redis tokenç¼“å­˜ + MySQLç”¨æˆ·æ•°æ®
- **è‡ªåŠ¨ç»­æœŸ**: Tokenå¤±æ•ˆæ—¶è‡ªåŠ¨é‡æ–°è®¤è¯
- **å®‰å…¨æœºåˆ¶**: æ”¯æŒç”¨æˆ·code+å¯†ç è®¤è¯
- **çŠ¶æ€ç®¡ç†**: å®Œæ•´çš„è®¤è¯çŠ¶æ€è·Ÿè¸ª

### 3. çœŸæ­£çš„æµå¼å¯¹è¯
- **å¼‚æ­¥å¤„ç†**: ç‹¬ç«‹çº¿ç¨‹å¤„ç†Difyå“åº”
- **æ¶ˆæ¯é˜Ÿåˆ—**: Rediså­˜å‚¨åˆ†æ®µæ¶ˆæ¯é˜Ÿåˆ—
- **é€æ­¥æ˜¾ç¤º**: ä¼å¾®é€æ¡è·å–å¹¶ç´¯ç§¯æ˜¾ç¤º
- **çŠ¶æ€åŒæ­¥**: è·¨èŠ‚ç‚¹çš„æµå¼çŠ¶æ€åŒæ­¥

### 4. ä¼ä¸šçº§å®‰å…¨
- **æ¶ˆæ¯åŠ å¯†**: AESåŠ å¯†ä¿æŠ¤æ¶ˆæ¯å†…å®¹
- **ç­¾åéªŒè¯**: éªŒè¯æ¶ˆæ¯æ¥æºåˆæ³•æ€§
- **é‡å¤æ£€æµ‹**: é˜²æ­¢é‡å¤è¯·æ±‚å¤„ç†
- **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤

## âš™ï¸ é…ç½®è¯´æ˜

### Redisé…ç½®
```python
REDIS_HOST = '**********'
REDIS_PORT = 6379
REDIS_PASSWORD = '**********'
REDIS_DB = 1
```

### MySQLé…ç½®
```python
MYSQL_HOST = '**********'
MYSQL_PORT = 3306
MYSQL_USER = '**********'
MYSQL_PASSWORD = '**********'
MYSQL_DATABASE = '**********'
```

### Difyå¹³å°é…ç½®
```python
DIFY_BASE_URL = 'http://**********'
DIFY_CHAT_ENDPOINT = '/v1/chat-messages'
DIFY_AUTH_PREFIX = 'Bearer'
```

### å¤–éƒ¨è®¤è¯æœåŠ¡
```python
AUTH_SERVICE_URL = 'http://***************************************'
```

## ğŸ”„ æ•°æ®æµè½¬

### 1. Redisæ•°æ®ç»“æ„

**ç”¨æˆ·Tokenç¼“å­˜**:
```
Key: authorization:wechatid:{from_user}
Value: {token}
TTL: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®
```

**TokenéªŒè¯ç¼“å­˜**:
```
Key: authorization:token:{token}
Value: {user_info}
TTL: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®
```

**æµå¼ä»»åŠ¡æ•°æ®**:
```
Key: dify_stream:{stream_id}
Value: {
  "content": "ç”¨æˆ·é—®é¢˜",
  "token": "ç”¨æˆ·token", 
  "user_info": {...},
  "status": "processing|completed|error",
  "conversation_id": "difyå¯¹è¯ID",
  "messages": [
    {
      "content": "å“åº”å†…å®¹å—",
      "read": false,
      "timestamp": "2025-01-15T10:30:00",
      "is_error": false,
      "is_final": false
    }
  ],
  "dify_finished": true
}
TTL: 1800ç§’ (30åˆ†é’Ÿ)
```


## ğŸŒ éƒ¨ç½²æ–¹æ¡ˆ

### 1. å•æœºéƒ¨ç½²
```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
copy demo.env .env

# å¯åŠ¨åº”ç”¨
python app.py
```

### 2. Dockeréƒ¨ç½²
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 5000

CMD ["python", "app.py"]
```

### 3. Kuberneteséƒ¨ç½²
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wechatlaibao
spec:
  replicas: 3
  selector:
    matchLabels:
      app: wechatlaibao
  template:
    metadata:
      labels:
        app: wechatlaibao
    spec:
      containers:
      - name: wechatlaibao
        image: wechatlaibao:latest
        ports:
        - containerPort: 5000
        env:
        - name: REDIS_HOST
          value: "redis-service"
        - name: MYSQL_HOST
          value: "mysql-service"
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—æ ¼å¼
```
[è°ƒè¯•] Difyè¿”å›å†…å®¹å— (é•¿åº¦: 245): æ‚¨å¥½ï¼Œ**ï¼å…³äºæ‚¨æåˆ°çš„å¯†ç è¿‡æœŸé—®é¢˜...
[è°ƒè¯•] ç´¯è®¡å†…å®¹é•¿åº¦: 1024, æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦: 3
[è°ƒè¯•] è¯»å–æœªè¯»æ¶ˆæ¯ - stream_id: uuid-1234
[è°ƒè¯•] æ¶ˆæ¯ç´¢å¼•: 1, å†…å®¹é•¿åº¦: 156
[è°ƒè¯•] å‰©ä½™æœªè¯»æ¶ˆæ¯æ•°: 2
```

### æ€§èƒ½æŒ‡æ ‡
- **å“åº”æ—¶é—´**: å¹³å‡ < 200ms
- **å¹¶å‘æ”¯æŒ**: > 1000 QPS
- **å†…å­˜ä½¿ç”¨**: < 512MB per node
- **Redisè¿æ¥**: è¿æ¥æ± å¤ç”¨

## ğŸš§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **Redisè¿æ¥å¤±è´¥**
   - æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
   - éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™
   - ç¡®è®¤å¯†ç å’Œç«¯å£é…ç½®

2. **MySQLè®¤è¯å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥å‚æ•°
   - éªŒè¯ç”¨æˆ·æƒé™å’Œè¡¨ç»“æ„
   - ç¡®è®¤SQLæŸ¥è¯¢è¯­å¥æ­£ç¡®æ€§

3. **Difyå“åº”è¶…æ—¶**
   - æ£€æŸ¥DifyæœåŠ¡å¯ç”¨æ€§
   - éªŒè¯ç½‘ç»œè¿æ¥å’ŒDNSè§£æ
   - è°ƒæ•´è¯·æ±‚è¶…æ—¶æ—¶é—´

4. **ä¼å¾®æ¶ˆæ¯è§£å¯†å¤±è´¥**
   - æ£€æŸ¥ä¼å¾®åº”ç”¨é…ç½®
   - éªŒè¯Tokenå’ŒEncodingAESKey
   - ç¡®è®¤æ¶ˆæ¯æ ¼å¼æ­£ç¡®æ€§

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. Redisä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± å‡å°‘è¿æ¥å¼€é”€
- åˆç†è®¾ç½®TTLé¿å…å†…å­˜æ³„æ¼
- æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œè¯·æ±‚

### 2. åº”ç”¨ä¼˜åŒ–
- å¼‚æ­¥å¤„ç†Difyè¯·æ±‚
- çº¿ç¨‹æ± ç®¡ç†å¹¶å‘ä»»åŠ¡
- ç¼“å­˜ç”¨æˆ·è®¤è¯ä¿¡æ¯

### 3. ç½‘ç»œä¼˜åŒ–
- å¯ç”¨HTTP keep-alive
- å‹ç¼©å“åº”æ•°æ®
- CDNåŠ é€Ÿé™æ€èµ„æº

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯: `git checkout -b feature/new-feature`
3. æäº¤æ›´æ”¹: `git commit -am 'Add new feature'`
4. æ¨é€åˆ†æ”¯: `git push origin feature/new-feature`  
5. æäº¤Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- åˆ›å»º [Issue](../../issues)
- å‘é€é‚®ä»¶è‡³æŠ€æœ¯æ”¯æŒ
- æŸ¥çœ‹ [Wiki](../../wiki) è·å–æ›´å¤šæ–‡æ¡£

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯·ç¡®ä¿ç¬¦åˆç›¸å…³æ³•å¾‹æ³•è§„å’Œä¼ä¸šå®‰å…¨è§„èŒƒã€‚